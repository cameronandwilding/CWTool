<?php
/**
 * @file
 *
 * Helper functions.
 */

use CW\Factory\EntityControllerFactory;
use CW\Form\VariableFormGenerator;
use CW\Manager\VariableManager;
use CW\Util\CronTimer;
use CW\Util\FormUtil;
use CW\Util\SimpleList;
use Symfony\Component\Config\FileLocator;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\DependencyInjection\Loader\YamlFileLoader;

require_once __DIR__ . '/vendor/autoload.php';
require_once __DIR__ . '/includes/cw_tool.content.inc';
require_once __DIR__ . '/includes/cw_tool.util.inc';

// Service names.
define('CWTOOL_SERVICE_NODE_FACTORY', 'cw.node-controller.factory');
define('CWTOOL_SERVICE_USER_FACTORY', 'cw.user-controller.factory');
define('CWTOOL_SERVICE_VARIABLE_MANAGER', 'cw.variable-manager');
define('CWTOOL_SERVICE_VARIABLE_ADAPTER', 'cw.variable-adapter');
define('CWTOOL_SERVICE_CRON_TIMER', 'cw.cron-timer');
define('CWTOOL_SERVICE_LOGGER', 'cw.logger');
define('CWTOOL_SERVICE_FILE_FACTORY', 'cw.file-controller.factory');
define('CWTOOL_SERVICE_TAXONOMY_TERM_FACTORY', 'cw.taxonomy-term-controller.factory');

/**
 * Get the dependency injection container.
 *
 * @return \Symfony\Component\DependencyInjection\ContainerBuilder
 */
function cw_tool_get_container() {
  static $container;

  if (!empty($container)) {
    return $container;
  }

  // @todo add weight so it's sortable
  $containerConfigs = new SimpleList();
  $containerConfigs->add(__DIR__ . '/config');
  drupal_alter('cw_tool_service_container_definition', $containerConfigs);

  $container = new ContainerBuilder();

  foreach ($containerConfigs->getAll() as $containerConfig) {
    $locator = new FileLocator(array($containerConfig));
    $loader = new YamlFileLoader($container, $locator);
    $loader->load('services.yml');
  }

  $container->compile();

  return $container;
}

/**
 * Implements hook_menu().
 */
function cw_tool_menu() {
  return array(
    // Admin section.
    'admin/config/application' => array(
      'title' => 'Application settings',
      'description' => 'Application settings.',
      'position' => 'left',
      'weight' => -10,
      'page callback' => 'system_admin_menu_block_page',
      'access arguments' => array('access administration pages'),
      'file' => 'system.admin.inc',
    ),

    // Variable settings page.
    'admin/config/application/variables' => array(
      'title' => 'Variables',
      'description' => 'Environment app variables.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('cw_tool_core_admin_settings_form'),
      'access arguments' => array('access administration pages'),
    ),
  );
}

function cw_tool_core_admin_settings_form($form) {
  /** @var VariableManager $variableManager */
  $variableManager = cw_tool_get_container()->get(CWTOOL_SERVICE_VARIABLE_MANAGER);
  $variableManager->collectAppVariables();
  $variablesForm = new VariableFormGenerator($variableManager);
  return $variablesForm->generateForm($form);
}

/**
 * @return CronTimer
 */
function cw_tool_cron_timer() {
  return cw_tool_get_container()->get(CWTOOL_SERVICE_CRON_TIMER);
}

/**
 * @return \CW\Adapter\VariableAdapter
 */
function cw_tool_variable_adapter() {
  return cw_tool_get_container()->get(CWTOOL_SERVICE_VARIABLE_ADAPTER);
}

/**
 * @return \Psr\Log\LoggerInterface
 */
function cw_tool_logger() {
  return cw_tool_get_container()->get(CWTOOL_SERVICE_LOGGER);
}

/**
 * @return EntityControllerFactory
 */
function cw_tool_file_factory() {
  return cw_tool_get_container()->get(CWTOOL_SERVICE_FILE_FACTORY);
}

/**
 * @return EntityControllerFactory
 */
function cw_tool_taxonomy_term_factory() {
  return cw_tool_get_container()->get(CWTOOL_SERVICE_TAXONOMY_TERM_FACTORY);
}

/**
 * CWTool form validator proxy for registered validator.
 *
 * @param array $form
 * @param array $form_state
 */
function cw_tool_form_util_validate(&$form, &$form_state) {
  FormUtil::callHook(FormUtil::HOOK_VALIDATE, $form, $form_state);
}

function cw_tool_form_util_submit(&$form, &$form_state) {
  FormUtil::callHook(FormUtil::HOOK_SUBMIT, $form, $form_state);
}

function cw_tool_form_util_after_build($form, $form_state) {
  return FormUtil::callAfterBuildHook($form, $form_state);
}

/**
 * Adds the CWTool JS file to the page load.
 */
function cw_tool_include_js() {
  drupal_add_js(drupal_get_path('module', 'cw_tool') . '/javascript/cw_tool.js');
}
