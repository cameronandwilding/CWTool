<?php

/**
 * @file
 * Manage the entity system.
 *
 * The module is mostly an anchor point for configuration items owned by the
 * entity system.
 */

use Drupal\Core\Config\Entity\ConfigStorageController;

/**
 * Implements hook_help().
 */
function entity_help($path, $arg) {
  switch ($path) {
    case 'admin/help#entity':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The Entity module manages various types of content and configuration for the website. This information is collectively know as "entities", which are grouped into "entity types" (such as the main site content, comments, custom blocks, taxonomy terms, user accounts, and views configuration). Some entity types are further grouped into sub-types (for example, you could have article and page content types within the main site content entity type, and tag and category vocabularies within the taxonomy term entity type); other entity types, such as user accounts, do not have sub-types.') . '</p>';
      $output .= '<p>' . t('Content entity types store most of their text, file, and other information in fields. See the <a href="!field">Field module help</a> and the <a href="!field_ui">Field UI help</a> pages for general information on fields and how to create and manage them.', array('!field' => \Drupal::url('help.page', array('name' => 'field')), '!field_ui' => \Drupal::url('help.page', array('name' => 'field_ui')))) . '</p>';
      $output .= '<p>' . t('Configuration entity types are used to store configuration information for your site, such as individual views in the Views module, and settings for your main site content types. Configuration stored in this way can be exported, imported, and managed using the Configuration Manager module. See the <a href="!config-help">Configuration Manager module help</a> page for more information.', array('!config-help' => \Drupal::url('help.page', array('name' => 'config')))) . '</p>';
      $output .= '<p>' . t('For more information, see the <a href="!entity_documentation">online documentation for the Entity module</a>.', array('!entity_documentation' => 'https://drupal.org/documentation/modules/entity')) . '</p>';
      $output .= '<h3>' . t('Uses') . '</h3>';
      $output .= '<dl>';
      $output .= '<dt>' . t('Managing view modes') . '</dt>';
      $output .= '<dd>' . t('Each content entity can have various "modes" for viewing. For instance, a content item could be viewed in full content mode on its own page, teaser mode in a list, or RSS mode in a feed. You can create, edit the names of, and delete view modes on the <a href="!view-modes">View modes page</a>. Once a view mode has been set up, you can choose and format fields for the view mode within each entity sub-type on the Manage display page. See the <a href="!field_ui">Field UI module help page</a> for more information.', array('!view-modes' => \Drupal::url('entity.view_mode_list'), '!field_ui' => \Drupal::url('help.page', array('name' => 'field_ui')))) . '</dd>';
      $output .= '<dt>' . t('Managing form modes') . '</dt>';
      $output .= '<dd>' . t('Each content entity can have various editing forms appropriate for different situations, which are known as "form modes". For instance, you might want to define a quick editing mode that allows users to edit the most important fields, and a full editing mode that gives access to all the fields. You can create, edit the names of, and delete form modes on the <a href="!form-modes">Manage custom form modes page</a>. Once a form mode has been set up, you can choose which fields are available on that form within each entity sub-type on the Manage form display page. See the <a href="!field_ui">Field UI module help page</a> for more information.', array('!form-modes' => \Drupal::url('entity.form_mode_list'), '!field_ui' => \Drupal::url('help.page', array('name' => 'field_ui')))) . '</dd>';
      $output .= '</dl>';
      return $output;
  }
}

/**
 * Implements hook_permission().
 */
function entity_permission() {
  return array(
    'administer display modes' => array(
      'title' => t('Add, edit, and delete custom display modes.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function entity_menu() {
  $items = array();

  $items['admin/structure/display-modes'] = array(
    'title' => 'Display modes',
    'description' => 'Configure what displays are available for your content and forms.',
    'route_name' => 'entity.display_mode',
  );

  // View modes.
  $items['admin/structure/display-modes/view'] = array(
    'title' => 'View modes',
    'description' => 'Manage custom view modes.',
    'route_name' => 'entity.view_mode_list',
  );
  $items['admin/structure/display-modes/view/add'] = array(
    'title' => 'Add view mode',
    'route_name' => 'entity.view_mode_add',
    'type' => MENU_SIBLING_LOCAL_TASK,
  );
  $items['admin/structure/display-modes/view/add/%'] = array(
    'route_name' => 'entity.view_mode_add_type',
  );
  $items['admin/structure/display-modes/view/manage/%/delete'] = array(
    'route_name' => 'entity.view_mode_delete',
  );

  // Form modes.
  $items['admin/structure/display-modes/form'] = array(
    'title' => 'Form modes',
    'description' => 'Manage custom form modes.',
    'route_name' => 'entity.form_mode_list',
  );
  $items['admin/structure/display-modes/form/add'] = array(
    'title' => 'Add form mode',
    'route_name' => 'entity.form_mode_add',
    'type' => MENU_SIBLING_LOCAL_TASK,
  );
  $items['admin/structure/display-modes/form/add/%'] = array(
    'route_name' => 'entity.form_mode_add_type',
  );
  $items['admin/structure/display-modes/form/manage/%/delete'] = array(
    'route_name' => 'entity.form_mode_delete',
  );

  return $items;
}

/**
 * Implements hook_menu_link_defaults().
 */
function entity_menu_link_defaults() {
  $links['entity.admin.structure.display_modes'] = array(
    'link_title' => 'Display modes',
    'description' => 'Configure what displays are available for your content and forms.',
    'route_name' => 'entity.display_mode',
    'parent' => 'system.admin.structure',
  );

  // View modes.
  $links['entity.admin.structure.display_modes.view'] = array(
    'link_title' => 'View modes',
    'description' => 'Manage custom view modes.',
    'route_name' => 'entity.view_mode_list',
    'parent' => 'entity.admin.structure.display_modes',
  );

  // Form modes.
  $links['entity.admin.structure.display_modes.form'] = array(
    'link_title' => 'Form modes',
    'description' => 'Manage custom form modes.',
    'route_name' => 'entity.form_mode_list',
    'parent' => 'entity.admin.structure.display_modes',
  );

  return $links;
}

/**
 * Implements hook_entity_bundle_rename().
 */
function entity_entity_bundle_rename($entity_type_id, $bundle_old, $bundle_new) {
  // Rename entity displays.
  $entity_type = \Drupal::entityManager()->getDefinition('entity_view_display');
  if ($bundle_old !== $bundle_new) {
    $ids = config_get_storage_names_with_prefix('entity.view_display.' . $entity_type_id . '.' . $bundle_old . '.');
    foreach ($ids as $id) {
      $id = ConfigStorageController::getIDFromConfigName($id, $entity_type->getConfigPrefix());
      $display = entity_load('entity_view_display', $id);
      $new_id = $entity_type_id . '.' . $bundle_new . '.' . $display->mode;
      $display->id = $new_id;
      $display->bundle = $bundle_new;
      $display->save();
    }
  }

  // Rename entity form displays.
  $entity_type = \Drupal::entityManager()->getDefinition('entity_form_display');
  if ($bundle_old !== $bundle_new) {
    $ids = config_get_storage_names_with_prefix('entity.form_display.' . $entity_type_id . '.' . $bundle_old . '.');
    foreach ($ids as $id) {
      $id = ConfigStorageController::getIDFromConfigName($id, $entity_type->getConfigPrefix());
      $form_display = entity_load('entity_form_display', $id);
      $new_id = $entity_type_id . '.' . $bundle_new . '.' . $form_display->mode;
      $form_display->id = $new_id;
      $form_display->bundle = $bundle_new;
      $form_display->save();
    }
  }
}

/**
 * Implements hook_entity_bundle_delete().
 */
function entity_entity_bundle_delete($entity_type_id, $bundle) {
  // Remove entity displays of the deleted bundle.
  $entity_type = \Drupal::entityManager()->getDefinition('entity_view_display');
  $ids = config_get_storage_names_with_prefix('entity.view_display.' . $entity_type_id . '.' . $bundle . '.');
  foreach ($ids as &$id) {
    $id = ConfigStorageController::getIDFromConfigName($id, $entity_type->getConfigPrefix());
  }
  entity_delete_multiple('entity_view_display', $ids);

  // Remove entity form displays of the deleted bundle.
  $entity_type = \Drupal::entityManager()->getDefinition('entity_form_display');
  $ids = config_get_storage_names_with_prefix('entity.form_display.' . $entity_type_id . '.' . $bundle . '.');
  foreach ($ids as &$id) {
    $id = ConfigStorageController::getIDFromConfigName($id, $entity_type->getConfigPrefix());
  }
  entity_delete_multiple('entity_form_display', $ids);
}

/**
 * Implements hook_module_preuninstall().
 */
function entity_module_preuninstall($module) {
  // Clean up all entity bundles (including field instances) of every entity
  // type provided by the module that is being uninstalled.
  foreach (\Drupal::entityManager()->getDefinitions() as $entity_type_id => $entity_type) {
    if ($entity_type->getProvider() == $module) {
      foreach (array_keys(entity_get_bundles($entity_type_id)) as $bundle) {
        entity_invoke_bundle_hook('delete', $entity_type_id, $bundle);
      }
    }
  }
}
